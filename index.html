<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ตารางเวรของฉัน | ระบบลงตารางเวรเภสัชกร</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif !important; }
    body { background: linear-gradient(135deg,#eff6ff 0%,#eef2ff 100%); }
    .card { transition: all .25s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(2,6,23,.08); }
    .spin { border:3px solid #e5e7eb; border-top-color:#2563eb; border-radius:9999px; width:18px; height:18px; animation:spin 1s linear infinite;}
    @keyframes spin {to{transform:rotate(360deg)}}
    .pill { @apply text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-200; }
  </style>
</head>
<body class="min-h-screen">

  <!-- ============ LOGIN ============ -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/90 backdrop-blur-md border border-indigo-100 rounded-2xl shadow-xl w-full max-w-md p-8 card">
      <div class="flex flex-col items-center text-center">
        <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3zm0 0c-3.314 0-6 2.686-6 6v1h12v-1c0-3.314-2.686-6-6-6z"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-slate-800">เข้าสู่ระบบ</h1>
        <p class="text-slate-600 mt-1">ระบบลงตารางเวรเภสัชกร</p>
      </div>

      <form id="loginForm" class="mt-6 space-y-4">
        <div>
          <label class="block text-sm text-slate-700 mb-1">User ID</label>
          <input id="userId" type="text" required
                 class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="เช่น p001">
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">Password</label>
          <input id="password" type="password" required
                 class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="••••••">
        </div>
        <button id="loginBtn" class="w-full flex items-center justify-center gap-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5">
          <span>เข้าสู่ระบบ</span>
          <span id="loginSpin" class="spin hidden"></span>
        </button>
        <p id="loginMsg" class="text-center text-sm text-red-600 hidden"></p>
      </form>
    </div>
  </main>

  <!-- ============ APP ============ -->
  <section id="appView" class="hidden">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <p class="text-xs text-slate-500">ตารางเวรของ</p>
            <h2 id="pharmacistName" class="text-lg font-semibold text-slate-800">-</h2>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="currentUserPill" class="pill">—</span>
          <button id="logoutBtn" class="rounded-lg bg-red-500 hover:bg-red-600 text-white px-3 py-2 text-sm">ออกจากระบบ</button>
        </div>
      </div>
    </header>

    <!-- Controls -->
    <div class="max-w-7xl mx-auto p-4">
      <div class="bg-white border border-indigo-100 rounded-2xl p-4 md:p-6 card">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-slate-700 mb-1">วันที่เริ่มต้น</label>
            <input id="startDate" type="date"
                   class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-slate-700 mb-1">วันที่สิ้นสุด</label>
            <input id="endDate" type="date"
                   class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div class="flex items-end">
            <button id="fetchBtn"
                    class="w-full md:w-auto rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 flex items-center justify-center gap-2">
              <span>ตรวจสอบเวร</span>
              <span id="fetchSpin" class="spin hidden"></span>
            </button>
          </div>
        </div>
        <p id="rangeMsg" class="text-sm text-red-600 mt-2 hidden"></p>
      </div>

      <!-- Content -->
      <div class="grid lg:grid-cols-3 gap-4 mt-4">
        <!-- Table -->
        <div class="lg:col-span-2">
          <div class="bg-white border border-slate-200 rounded-2xl card overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
              <h3 class="font-semibold text-slate-800">ตารางเวร</h3>
              <span id="totalBadge" class="pill">รวมเวร: 0</span>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full">
                <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
                  <tr>
                    <th class="text-left px-4 py-2">ชื่อเวร</th>
                    <th class="text-left px-4 py-2">ตัวย่อเวร</th>
                    <th class="text-left px-4 py-2">วันที่อยู่เวร</th>
                    <th class="text-right px-4 py-2">การทำงาน</th>
                  </tr>
                </thead>
                <tbody id="rowsBody" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
            <div id="emptyHint" class="p-6 text-center text-slate-500 hidden">ไม่พบข้อมูลในช่วงวันที่ที่เลือก</div>
          </div>
        </div>

        <!-- Stats -->
        <aside class="space-y-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <h4 class="font-semibold text-slate-800 mb-3">สรุปจำนวนเวร</h4>
            <div id="sumAll" class="text-3xl font-bold text-blue-700">0</div>
            <p class="text-sm text-slate-500">รวมทั้งหมดในช่วงวันที่ที่เลือก</p>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <h4 class="font-semibold text-slate-800 mb-3">แจกแจงตามเวร</h4>
            <div id="byShift" class="space-y-2 text-sm text-slate-700">
              <!-- items -->
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <script>
  // ========= CONFIG =========
  const CONFIG = {
    // ใช้ URL ของ Apps Script “อันเดียวกับระบบเดิม” (แก้ให้ตรงของคุณ)
    SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzelakl6CeFm9gQ5X0GVADSq1_myTiE-mi5lD2i6an8JnFCZa5QDPEodutobPWkvGSK/exec'
  };
  // ==========================

  // State
  let currentUser = null;        // { userId, name }
  let pharmacistNameByUserId = {}; // map userId -> name
  let shifts = [];               // [{name, abbrev}]
  let shiftAbbrevMap = {};       // name -> abbrev
  let currentRows = [];          // rows currently displayed

  // DOM
  const loginView = document.getElementById('loginView');
  const appView   = document.getElementById('appView');
  const loginForm = document.getElementById('loginForm');
  const loginBtn  = document.getElementById('loginBtn');
  const loginSpin = document.getElementById('loginSpin');
  const loginMsg  = document.getElementById('loginMsg');

  const pharmacistNameEl = document.getElementById('pharmacistName');
  const currentUserPill  = document.getElementById('currentUserPill');
  const logoutBtn        = document.getElementById('logoutBtn');

  const startDateEl = document.getElementById('startDate');
  const endDateEl   = document.getElementById('endDate');
  const fetchBtn    = document.getElementById('fetchBtn');
  const fetchSpin   = document.getElementById('fetchSpin');
  const rangeMsg    = document.getElementById('rangeMsg');

  const rowsBody    = document.getElementById('rowsBody');
  const totalBadge  = document.getElementById('totalBadge');
  const emptyHint   = document.getElementById('emptyHint');
  const sumAllEl    = document.getElementById('sumAll');
  const byShiftEl   = document.getElementById('byShift');

  // Default date range = เดือนปัจจุบัน
  (function presetDates(){
    const today = new Date();
    const first = new Date(today.getFullYear(), today.getMonth(), 1);
    const last  = new Date(today.getFullYear(), today.getMonth()+1, 0);
    startDateEl.value = toInputDate(first);
    endDateEl.value   = toInputDate(last);
  })();

  // ===== Helpers =====
  function toInputDate(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function fmtDate(dstr){ if(!dstr) return ''; const d=new Date(dstr); return toInputDate(d); }
  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }

  async function apiGet(params){
    const url = `${CONFIG.SCRIPT_URL}?` + new URLSearchParams(params).toString();
    const r = await fetch(url); return r.json();
  }
  async function apiPost(payload){
    const r = await fetch(CONFIG.SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    return r.json();
  }

  // ===== Login =====
  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    hide(loginMsg); loginMsg.textContent = '';
    loginBtn.disabled = true; show(loginSpin);

    const userId = document.getElementById('userId').value.trim();
    const password = document.getElementById('password').value.trim();

    try{
      const res = await apiPost({ action:'login', userId, password });
      if(!res.success) throw new Error(res.message || 'เข้าสู่ระบบไม่สำเร็จ');
      currentUser = { userId: res.userId, name: res.name };
      // โหลดข้อมูลอ้างอิง
      await loadRefs();
      // ผูกชื่อบนหัว
      pharmacistNameEl.textContent = currentUser.name || '-';
      currentUserPill.textContent  = `${currentUser.name} (${currentUser.userId})`;
      // เปิดแอป
      hide(loginView); show(appView);
      // โหลดเวรครั้งแรก
      fetchBtn.click();
    }catch(err){
      loginMsg.textContent = err.message || 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ';
      show(loginMsg);
    }finally{
      loginBtn.disabled = false; hide(loginSpin);
    }
  });

  logoutBtn.addEventListener('click', ()=>{
    currentUser = null;
    show(loginView); hide(appView);
    loginForm.reset();
  });

  // ===== References (Pharmacists/Shifts) =====
  async function loadRefs(){
    try{
      // getPharmacistsDetailed
      const ph = await apiGet({ action:'getPharmacistsDetailed' });
      pharmacistNameByUserId = {};
      (ph?.pharmacists || []).forEach(p=>{
        const uid = String(p.userId||'').trim().toLowerCase();
        if(uid) pharmacistNameByUserId[uid] = p.name || '';
      });

      // getShiftsDetailed → map for abbrev lookup
      const sh = await apiGet({ action:'getShiftsDetailed' });
      shifts = sh?.shifts || [];
      shiftAbbrevMap = {};
      shifts.forEach(s=>{
        shiftAbbrevMap[(s.name||'').trim()] = s.abbrev || '';
      });
    }catch(e){
      // ไม่เป็นไร ใช้ fallback ตอนเรนเดอร์
      console.warn('loadRefs error', e);
    }
  }

  // ===== Fetch rows =====
  fetchBtn.addEventListener('click', fetchSchedules);

  async function fetchSchedules(){
    hide(rangeMsg);
    const startDate = startDateEl.value;
    const endDate   = endDateEl.value;
    if(!startDate || !endDate){
      rangeMsg.textContent = 'กรุณาเลือกช่วงวันที่ให้ครบถ้วน';
      show(rangeMsg); return;
    }
    if(new Date(startDate) > new Date(endDate)){
      rangeMsg.textContent = 'วันที่เริ่มต้นต้องไม่มากกว่าวันที่สิ้นสุด';
      show(rangeMsg); return;
    }

    fetchBtn.disabled = true; show(fetchSpin);
    try{
      // 1) พยายามดึงตามผู้บันทึก (เร็วสุด)
      let list = [];
      const r1 = await apiGet({ action:'getUserSchedulesRange', userId: currentUser.userId, startDate, endDate });
      if(Array.isArray(r1?.schedules)) list = r1.schedules;

      // 2) ถ้ายังว่าง (เช่น เวรถูกบันทึกโดยคนอื่น) → fallback ดึงรายงานแล้วกรองตาม “ชื่อ”
      if((list?.length||0) === 0){
        const rep = await apiGet({ action:'getScheduleReport', startDate, endDate });
        const all = rep?.schedules || [];
        const myName = (currentUser.name || '').trim();
        list = all.filter(x => String(x.pharmacist||'').trim() === myName);
      }

      // ให้มีฟิลด์ที่ต้องใช้เสมอ
      currentRows = (list || []).map(x => ({
        id: x.id,
        shift: x.shift,
        abbrev: x.abbrev || shiftAbbrevMap[(x.shift||'').trim()] || '',
        workDate: x.workDate || x.date
      }));

      renderTable(currentRows);
      renderStats(currentRows);
    }catch(e){
      rangeMsg.textContent = 'เกิดข้อผิดพลาดในการดึงข้อมูล'; show(rangeMsg);
      console.error(e);
    }finally{
      fetchBtn.disabled = false; hide(fetchSpin);
    }
  }

  // ===== Render table & stats =====
  function renderTable(rows){
    rowsBody.innerHTML = '';
    if((rows?.length||0) === 0){
      show(emptyHint);
      totalBadge.textContent = 'รวมเวร: 0';
      return;
    }
    hide(emptyHint);
    totalBadge.textContent = `รวมเวร: ${rows.length}`;

    rows.forEach(r=>{
      const tr = document.createElement('tr');

      const tdShift = td(r.shift || '-', 'px-4 py-2 text-slate-800');
      const tdAbbr  = td(r.abbrev || '-', 'px-4 py-2 text-slate-600');
      const tdDate  = td(fmtDate(r.workDate), 'px-4 py-2 text-slate-700');

      const tdAct   = document.createElement('td');
      tdAct.className = 'px-4 py-2 text-right';
      const delBtn = document.createElement('button');
      delBtn.className = 'text-sm rounded-md bg-red-500 hover:bg-red-600 text-white px-3 py-1.5';
      delBtn.textContent = 'ลบเวร';
      delBtn.addEventListener('click', ()=> onDeleteRow(r.id));
      tdAct.appendChild(delBtn);

      tr.append(tdShift, tdAbbr, tdDate, tdAct);
      rowsBody.appendChild(tr);
    });
  }
  function td(text, cls){ const td=document.createElement('td'); td.className=cls; td.textContent=text; return td; }

  function renderStats(rows){
    const total = rows.length;
    sumAllEl.textContent = total;

    const by = {};
    rows.forEach(r=>{
      const key = r.shift || '-';
      by[key] = (by[key]||0) + 1;
    });
    byShiftEl.innerHTML = '';
    Object.keys(by).sort().forEach(k=>{
      const line = document.createElement('div');
      line.className = 'flex items-center justify-between';
      const left = document.createElement('span');
      left.textContent = `${k} (${shiftAbbrevMap[k]||'-'})`;
      const right = document.createElement('span');
      right.className = 'font-semibold text-slate-800';
      right.textContent = by[k];
      line.append(left,right);
      byShiftEl.appendChild(line);
    });
  }

  // ===== Delete row =====
  async function onDeleteRow(id){
    if(!id) return;
    const ok = confirm('ยืนยันการลบเวรนี้หรือไม่?');
    if(!ok) return;

    // ปรับปุ่มให้มีสถานะโหลด
    const btn = event?.currentTarget;
    if(btn){ btn.disabled = true; btn.textContent = 'กำลังลบ...'; }

    try{
      // ต้องส่ง userId เพื่อสิทธิ์ลบ (Apps Script จะปฏิเสธหากเป็นเวรของผู้อื่นที่บันทึก)
      const res = await apiPost({ action:'deleteSchedules', ids:[String(id)], userId: currentUser.userId });
      if(!res.success){
        alert(res.message || 'ลบไม่สำเร็จ');
      }else{
        // เอาออกจาก state และเรนเดอร์ใหม่
        currentRows = currentRows.filter(x=> String(x.id) !== String(id));
        renderTable(currentRows);
        renderStats(currentRows);
      }
    }catch(e){
      alert('เกิดข้อผิดพลาดในการลบ');
      console.error(e);
    }finally{
      if(btn){ btn.disabled = false; btn.textContent = 'ลบเวร'; }
    }
  }
  </script>
</body>
</html>
